import streamlit as st
import easyocr
from PIL import Image
import re
# --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ---
st.set_page_config(page_title="‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©", layout="wide")
@st.cache_resource
def load_ocr():
    # ‡πÇ‡∏´‡∏•‡∏î AI ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
    return easyocr.Reader(['th', 'en'])

# --- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° (Style Mahidol) ---
st.markdown("""
    <div style="background-color: #0046ad; padding: 20px; border-radius: 10px; color: white; text-align: center;">
        <h2 style="margin:0;">üéì ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©</h2>
        <p style="margin:5px;">‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ú‡∏•‡∏á‡∏≤‡∏ô 1 ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á (2564-2568) ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô Scopus ‡∏´‡∏£‡∏∑‡∏≠ TCI 1-2</p>
    </div>
""", unsafe_allow_html=True)
# ‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
st.subheader("üì§ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏á‡∏≤‡∏ô")
uploaded_file = st.file_uploader("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° (JPG, PNG)", type=["jpg", "jpeg", "png"])
if uploaded_file is not None:
    st.image(uploaded_file, caption="‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î", width=400)  
    if st.button("‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏î‡πâ‡∏ß‡∏¢ AI ‚ûî", type="primary"):
        with st.spinner("AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç TCI 1-2..."):
            # ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ AI ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            reader = load_ocr()
            image = Image.open(uploaded_file)
            result = reader.readtext(image, detail=0)
            full_text = " ".join(result).lower()
            # 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ (‡∏û.‡∏®. 2564-2568 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ.‡∏®. 2021-2025)
            years = re.findall(r'256[4-8]|202[1-5]', full_text)
            # 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏£‡∏ß‡∏° TCI 2 ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            db_keywords = ["scopus", "tci 1", "tci 2", "tci1", "tci2", "‡∏Å‡∏•‡∏∏‡πà‡∏° 1", "‡∏Å‡∏•‡∏∏‡πà‡∏° 2", "tier 1", "tier 2", "journal"]
            found_db = [db for db in db_keywords if db in full_text]
            st.divider()
            # --- ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• ---
            if years and found_db:
                st.balloons()
                st.success("### üéâ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥")
                st.write(f"‚úÖ **‡∏û‡∏ö‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå:** {', '.join(set(years))}")
                st.write(f"‚úÖ **‡∏û‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:** {', '.join(set(found_db))}")
            else:
                st.error("### ‚ùå ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥")
                if not years:
                    st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏µ ‡∏û.‡∏®. 2564-2568 ‡πÉ‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£")
                if not found_db:
                    st.warning("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Keyword ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Scopus ‡∏´‡∏£‡∏∑‡∏≠ TCI 1-2")
            with st.expander("‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà AI ‡∏™‡πÅ‡∏Å‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"):
                st.write(full_text)
